<!DOCTYPE html>
<!--
    GhostStream Web Player Example
    
    HOW TO USE:
    1. Start GhostStream: python run.py
    2. Serve this file via HTTP (don't open directly from filesystem):
       
       cd examples
       python -m http.server 8080
       
    3. Open http://localhost:8080/web_player.html in your browser
    
    NOTE: Opening this file directly (file://) won't work due to browser
    security restrictions (CORS). You must serve it over HTTP.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostStream Web Player Example</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e; 
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #00d4ff; }
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input, select, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }
        input, select { background: #0f3460; color: #fff; }
        button {
            background: #00d4ff;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #00a8cc; }
        button:disabled { background: #555; cursor: not-allowed; }
        .btn-danger { background: #e94560; color: #fff; }
        .btn-danger:hover { background: #c73e54; }
        video {
            width: 100%;
            border-radius: 12px;
            background: #000;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: monospace;
            font-size: 13px;
        }
        .status.info { background: #0f3460; }
        .status.success { background: #1b4332; }
        .status.error { background: #5c1a1a; }
        .progress-bar {
            height: 8px;
            background: #0f3460;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }
        .progress-bar .fill {
            height: 100%;
            background: #00d4ff;
            transition: width 0.3s;
        }
        .row { display: flex; gap: 12px; }
        .row > * { flex: 1; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ GhostStream Web Player</h1>
        
        <!-- Config -->
        <div class="card">
            <label>GhostStream Server</label>
            <input type="text" id="serverUrl" value="http://localhost:8765" placeholder="http://localhost:8765">
            <button onclick="checkHealth()">Check Connection</button>
            <div id="healthStatus" class="status info hidden"></div>
        </div>

        <!-- Transcode Form -->
        <div class="card">
            <label>Video Source URL</label>
            <input type="text" id="sourceUrl" placeholder="https://example.com/video.mp4">
            
            <div class="row">
                <div>
                    <label>Mode</label>
                    <select id="mode">
                        <option value="stream">HLS Stream (single quality)</option>
                        <option value="abr">ABR (multiple qualities)</option>
                    </select>
                </div>
                <div>
                    <label>Resolution</label>
                    <select id="resolution">
                        <option value="1080p">1080p</option>
                        <option value="720p" selected>720p</option>
                        <option value="480p">480p</option>
                        <option value="original">Original</option>
                    </select>
                </div>
            </div>
            
            <button id="startBtn" onclick="startTranscode()">‚ñ∂ Start Transcoding</button>
        </div>

        <!-- Progress -->
        <div id="progressCard" class="card hidden">
            <label>Transcoding Progress</label>
            <div class="progress-bar"><div class="fill" id="progressFill" style="width: 0%"></div></div>
            <div id="progressText" class="status info">Starting...</div>
            <button class="btn-danger" onclick="cancelJob()">‚úï Cancel</button>
        </div>

        <!-- Player -->
        <div id="playerCard" class="card hidden">
            <video id="videoPlayer" controls></video>
            <div class="status success" id="streamInfo"></div>
            <button class="btn-danger" onclick="stopPlayback()">‚ñ† Stop & Cleanup</button>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let hls = null;
        let pollInterval = null;

        function getServer() {
            return document.getElementById('serverUrl').value.replace(/\/$/, '');
        }

        async function checkHealth() {
            const statusEl = document.getElementById('healthStatus');
            statusEl.classList.remove('hidden', 'success', 'error');
            statusEl.classList.add('info');
            statusEl.textContent = 'Checking...';

            try {
                const resp = await fetch(`${getServer()}/api/health`);
                const data = await resp.json();
                statusEl.classList.remove('info');
                statusEl.classList.add('success');
                statusEl.textContent = `‚úÖ Connected - v${data.version} | Active: ${data.current_jobs} jobs`;
            } catch (e) {
                statusEl.classList.remove('info');
                statusEl.classList.add('error');
                statusEl.textContent = `‚ùå Cannot connect: ${e.message}`;
            }
        }

        async function startTranscode() {
            const source = document.getElementById('sourceUrl').value;
            if (!source) {
                alert('Enter a video source URL');
                return;
            }

            const mode = document.getElementById('mode').value;
            const resolution = document.getElementById('resolution').value;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('progressCard').classList.remove('hidden');
            document.getElementById('playerCard').classList.add('hidden');

            try {
                const resp = await fetch(`${getServer()}/api/transcode/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source,
                        mode,
                        output: {
                            resolution: mode === 'abr' ? 'original' : resolution,
                            video_codec: 'h264'
                        }
                    })
                });

                const job = await resp.json();
                currentJobId = job.job_id;
                document.getElementById('progressText').textContent = `Job: ${currentJobId}`;

                // Poll for status
                pollInterval = setInterval(pollStatus, 1000);
            } catch (e) {
                document.getElementById('progressText').textContent = `‚ùå Error: ${e.message}`;
                document.getElementById('startBtn').disabled = false;
            }
        }

        async function pollStatus() {
            if (!currentJobId) return;

            try {
                const resp = await fetch(`${getServer()}/api/transcode/${currentJobId}/status`);
                const status = await resp.json();

                const progress = status.progress || 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = 
                    `${status.status.toUpperCase()} - ${progress.toFixed(1)}% | HW: ${status.hw_accel_used || 'pending'}`;

                if (status.status === 'ready') {
                    clearInterval(pollInterval);
                    playStream(status.stream_url);
                } else if (status.status === 'error' || status.status === 'cancelled') {
                    clearInterval(pollInterval);
                    document.getElementById('progressText').textContent = `‚ùå ${status.status}: ${status.error || 'Job ended'}`;
                    document.getElementById('startBtn').disabled = false;
                }
            } catch (e) {
                console.error('Poll error:', e);
            }
        }

        function playStream(streamUrl) {
            document.getElementById('progressCard').classList.add('hidden');
            document.getElementById('playerCard').classList.remove('hidden');
            
            // Rewrite stream URL to use configured server (avoids CORS when server returns LAN IP)
            const serverBase = getServer();
            const urlPath = new URL(streamUrl).pathname;
            const localStreamUrl = serverBase + urlPath;
            
            document.getElementById('streamInfo').textContent = `üé¨ Playing: ${localStreamUrl}`;

            const video = document.getElementById('videoPlayer');

            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(localStreamUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari native HLS
                video.src = localStreamUrl;
                video.play();
            } else {
                document.getElementById('streamInfo').textContent = '‚ùå HLS not supported in this browser';
            }
        }

        async function cancelJob() {
            if (!currentJobId) return;
            clearInterval(pollInterval);
            
            try {
                await fetch(`${getServer()}/api/transcode/${currentJobId}/cancel`, { method: 'POST' });
            } catch (e) {}
            
            document.getElementById('progressCard').classList.add('hidden');
            document.getElementById('startBtn').disabled = false;
            currentJobId = null;
        }

        async function stopPlayback() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            document.getElementById('videoPlayer').src = '';
            document.getElementById('playerCard').classList.add('hidden');

            if (currentJobId) {
                try {
                    await fetch(`${getServer()}/api/transcode/${currentJobId}`, { method: 'DELETE' });
                } catch (e) {}
                currentJobId = null;
            }

            document.getElementById('startBtn').disabled = false;
        }

        // Check health on load
        checkHealth();
    </script>
</body>
</html>
